{% extends 'training/base.html' %}

{% block content %}

<style>
    /* === é¡µé¢ä¸“å±æ ·å¼ === */
    .review-container {
        max-width: 800px;
        margin: 0 auto;
    }

    /* è¿”å›é“¾æ¥ */
    .back-link {
        color: #8c98a4;
        text-decoration: none;
        display: inline-flex; align-items: center; gap: 5px;
        margin-bottom: 25px; transition: color 0.2s;
        font-size: 0.9rem;
    }
    .back-link:hover { color: var(--primary-color); }

    /* === ä¸»å¡ç‰‡ === */
    .review-card {
        background: var(--card-bg);
        border: none;
        border-radius: 24px;
        padding: 40px;
        box-shadow: var(--shadow-light);
        position: relative;
        overflow: hidden;
    }

    /* é¡¶éƒ¨è£…é¥°æ¡ */
    .review-card::before {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 6px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    /* === å¤´éƒ¨ä¿¡æ¯ === */
    .header-info {
        text-align: center;
        margin-bottom: 40px;
    }
    .page-title {
        font-family: 'Cinzel', serif;
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--primary-color);
        margin-bottom: 10px;
        letter-spacing: 1px;
    }
    .student-badge {
        display: inline-flex;
        align-items: center;
        background: #f8f9fa;
        padding: 8px 20px;
        border-radius: 50px;
        font-size: 0.95rem;
        color: #555;
        border: 1px solid #eee;
        gap: 10px;
    }
    .student-badge strong { color: var(--primary-color); }
    .submit-time {
        font-size: 0.8rem;
        color: #aaa;
        margin-top: 10px;
        display: block;
    }

    /* === 1. æ–‡å­—ç‚¹è¯„åŒº (ä¿¡ç¬ºé£æ ¼) === */
    .text-review-section {
        background: linear-gradient(to bottom right, #fdfbf7, #fffbf0);
        border-radius: 15px;
        padding: 25px;
        border: 1px solid rgba(212, 175, 55, 0.15);
        margin-bottom: 30px;
    }
    .section-label {
        font-family: 'Cinzel', serif;
        font-weight: 700;
        color: var(--accent-color);
        font-size: 0.9rem;
        letter-spacing: 1px;
        margin-bottom: 15px;
        display: block;
    }
    .form-control-review {
        background: transparent;
        border: none;
        width: 100%;
        resize: none;
        outline: none;
        font-size: 1rem;
        line-height: 1.8;
        color: #4a5568;
        background-image: linear-gradient(transparent 95%, rgba(212, 175, 55, 0.1) 95%);
        background-size: 100% 2rem; /* è¡Œé«˜å‚è€ƒçº¿ */
        padding: 0;
    }
    .form-control-review:focus { box-shadow: none; }

    /* === 2. è¯­éŸ³å½•åˆ¶å° (å¤ç”¨ç»ƒä¹ é¡µé£æ ¼) === */
    .audio-review-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        border: 1px dashed #e2e8f0;
        margin-bottom: 30px;
    }

    .record-btn-wrapper {
        width: 80px; height: 80px;
        margin: 0 auto 15px;
        position: relative;
    }

    .record-btn {
        width: 100%; height: 100%;
        border-radius: 50%;
        border: none;
        background: white;
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #f0f0f0;
        color: #555;
    }

    .record-btn:hover { transform: scale(1.05); }

    /* å½•éŸ³ä¸­çŠ¶æ€ */
    .record-btn.recording {
        background: #e74c3c;
        color: white;
        border-color: #c0392b;
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); transform: scale(1); }
        70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); transform: scale(1.05); }
        100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); transform: scale(1); }
    }

    /* === åº•éƒ¨æŒ‰é’® === */
    .btn-submit {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 15px;
        width: 100%;
        font-size: 1.1rem;
        letter-spacing: 2px;
        box-shadow: 0 5px 20px rgba(44, 62, 80, 0.2);
        transition: all 0.3s;
    }
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(44, 62, 80, 0.3);
        background-color: #34495e;
        color: white;
    }
    .btn-submit:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
        transform: none;
    }

    /* === ä¼˜é›… Toast === */
    .toast-container {
        position: fixed; top: 20px; left: 50%;
        transform: translateX(-50%); z-index: 1050;
    }
    .grace-toast {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 12px 25px;
        border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        display: flex; align-items: center; gap: 10px;
        transform: translateY(-100px); opacity: 0;
        transition: all 0.5s;
        border: 1px solid rgba(212, 175, 55, 0.2);
    }
    .grace-toast.show { transform: translateY(0); opacity: 1; }
</style>

<div class="toast-container">
    <div id="graceToast" class="grace-toast">
        <span id="toastIcon" style="font-size: 1.2rem;">âœ¨</span>
        <span id="toastMsg" style="font-weight: 500; font-size: 0.95rem;"></span>
    </div>
</div>

<div class="review-container">
    <a href="{% url 'teacher_dashboard' %}" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
        </svg>
        è¿”å›ä½œä¸šåˆ—è¡¨
    </a>

    <div class="review-card">
        <div class="header-info">
            <div class="page-title">ASSIGNMENT REVIEW</div>
            <div class="student-badge">
                <span>ğŸ‘¤ å­¦å‘˜ï¼š<strong>{{ record.student.username }}</strong></span>
                <span style="color:#ddd">|</span>
                <span>ğŸµ ç»ƒä¹ ï¼š<strong>{{ record.exercise.title }}</strong></span>
            </div>
            <span class="submit-time">æäº¤äº {{ record.submitted_at|date:"Y.m.d H:i" }}</span>
        </div>

        <form id="review-form">
            {% csrf_token %}

            <div class="text-review-section">
                <label class="section-label">âœï¸ WRITTEN FEEDBACK</label>
                <textarea name="comment_text" class="form-control-review" rows="6" placeholder="åœ¨æ­¤å†™ä¸‹æ‚¨çš„å»ºè®®ä¸é¼“åŠ±...">{{ record.teacher_comment_text|default:'' }}</textarea>
            </div>

            <div class="audio-review-section">
                <label class="section-label mb-3">ğŸ¤ VOICE FEEDBACK</label>

                <div class="record-btn-wrapper">
                    <button type="button" id="recordBtn" class="record-btn" onclick="toggleRecording()">
                        <span id="btnIcon" style="font-size: 24px;">ğŸ™ï¸</span>
                    </button>
                </div>
                <p id="recordStatus" class="text-muted small mb-3">ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³</p>

                <div id="preview-box" style="display:none;" class="mt-3 bg-light p-3 rounded">
                    <small class="text-primary d-block mb-2">ğŸ§ å³å°†ä¿å­˜çš„å½•éŸ³ï¼š</small>
                    <audio id="audio-preview" controls src="" class="w-100"></audio>
                    <button type="button" class="btn btn-sm btn-link text-danger mt-2" onclick="resetRecording()">ğŸ—‘ æ’¤é”€é‡å½•</button>
                </div>

                {% if record.teacher_comment_audio %}
                    <div id="history-audio" class="mt-3 pt-3 border-top">
                        <small class="text-success d-block mb-2">âœ… å·²å‘å¸ƒçš„å½•éŸ³ï¼š</small>
                        <audio controls src="{{ record.teacher_comment_audio.url }}" class="w-100"></audio>
                    </div>
                {% endif %}
            </div>

            <button type="button" onclick="submitReview()" class="btn-submit">
                ğŸ’¾ ä¿å­˜å¹¶è¿”å› Â· SAVE
            </button>
        </form>

    </div>
</div>

<script>
    // === æ©å…¸æç¤ºæ¡†é€»è¾‘ ===
    function showToast(message, type='success') {
        const toast = document.getElementById('graceToast');
        const msg = document.getElementById('toastMsg');
        const icon = document.getElementById('toastIcon');

        msg.innerText = message;
        icon.innerText = type === 'recording' ? 'ğŸ”´' : (type === 'success' ? 'âœ…' : 'âš ï¸');
        toast.classList.add('show');

        if(type !== 'recording') {
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    }

    // === å½•éŸ³é€»è¾‘ ===
    let mediaRecorder;
    let audioChunks = [];
    let recordedBlob = null;
    let isRecording = false;

    const recordBtn = document.getElementById('recordBtn');
    const btnIcon = document.getElementById('btnIcon');
    const statusText = document.getElementById('recordStatus');
    const previewBox = document.getElementById('preview-box');
    const audioPreview = document.getElementById('audio-preview');

    function toggleRecording() {
        if (!isRecording) startRecording();
        else stopRecording();
    }

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.start();
            audioChunks = [];
            recordedBlob = null;

            // UI çŠ¶æ€ï¼šå½•éŸ³ä¸­
            isRecording = true;
            recordBtn.classList.add('recording');
            btnIcon.innerText = 'â– ';
            statusText.innerText = "æ­£åœ¨å½•éŸ³... (ç‚¹å‡»åœæ­¢)";
            showToast("Recording...", "recording");
            previewBox.style.display = 'none'; // éšè—é¢„è§ˆ

            mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
            mediaRecorder.addEventListener("stop", () => {
                recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(recordedBlob);
                audioPreview.src = audioUrl;

                // UI çŠ¶æ€ï¼šå½•éŸ³å®Œæˆ
                previewBox.style.display = 'block';
                statusText.innerText = "å½•éŸ³å®Œæˆï¼Œè¯·è¯•å¬";
                // éšè—å†å²å½•éŸ³ä»¥å…æ··æ·†
                const historyBox = document.getElementById('history-audio');
                if(historyBox) historyBox.style.display = 'none';
            });

        } catch (err) {
            console.error(err);
            showToast("æ— æ³•è®¿é—®éº¦å…‹é£", "error");
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            // UI çŠ¶æ€ï¼šæ¢å¤
            isRecording = false;
            recordBtn.classList.remove('recording');
            btnIcon.innerText = 'ğŸ™ï¸';
            document.getElementById('graceToast').classList.remove('show');

            // åœæ­¢éº¦å…‹é£æµ
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
    }

    function resetRecording() {
        recordedBlob = null;
        previewBox.style.display = 'none';
        statusText.innerText = "ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³";
        // æ¢å¤æ˜¾ç¤ºå†å²å½•éŸ³
        const historyBox = document.getElementById('history-audio');
        if(historyBox) historyBox.style.display = 'block';
    }

    // === æäº¤é€»è¾‘ ===
    function submitReview() {
        const form = document.getElementById('review-form');
        const formData = new FormData(form);
        const btn = document.querySelector('.btn-submit');

        // å¦‚æœæœ‰æ–°å½•éŸ³ï¼Œæ·»åŠ åˆ°è¡¨å•
        if (recordedBlob) {
            formData.append('audio_data', recordedBlob, 'teacher_review.webm');
        }

        btn.disabled = true;
        btn.innerText = "æ­£åœ¨ä¿å­˜ Â· SAVING...";
        showToast("æ­£åœ¨ä¿å­˜ç‚¹è¯„...", "loading");

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                showToast("ğŸ‰ ä¿å­˜æˆåŠŸï¼", "success");
                setTimeout(() => window.location.href = "{% url 'teacher_dashboard' %}", 1000);
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + data.msg);
                btn.disabled = false;
                btn.innerText = "ğŸ’¾ ä¿å­˜å¹¶è¿”å› Â· SAVE";
            }
        })
        .catch(err => {
            console.error(err);
            showToast("ç½‘ç»œé”™è¯¯", "error");
            btn.disabled = false;
            btn.innerText = "ğŸ’¾ ä¿å­˜å¹¶è¿”å› Â· SAVE";
        });
    }
</script>

{% endblock %}