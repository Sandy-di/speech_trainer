{% extends 'training/base.html' %}

{% block content %}

<style>
    /* === é¡µé¢æ ·å¼ === */
    .summary-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        border: none;
        overflow: hidden;
        margin-top: 20px;
    }
    .card-header-styled {
        background: linear-gradient(to right, #fff, #fdfbf7);
        padding: 30px;
        border-bottom: 1px solid #f0f0f0;
    }
    .page-title {
        font-family: 'Cinzel', serif;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    .sub-title {
        color: #999;
        font-size: 0.9rem;
    }

    /* å½•éŸ³åŒºåŸŸ */
    .audio-recorder-box {
        background: #f8f9fa;
        border: 2px dashed #e0e0e0;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s;
    }
    .audio-recorder-box.recording {
        border-color: #e74c3c;
        background: rgba(231, 76, 60, 0.05);
    }

    .rec-btn {
        width: 70px; height: 70px;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 15px;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    /* åˆå§‹çŠ¶æ€ */
    .rec-btn.start { background: white; color: #e74c3c; border: 2px solid #e74c3c; }
    .rec-btn.start:hover { transform: scale(1.05); background: #e74c3c; color: white; }

    /* å½•éŸ³ä¸­ */
    .rec-btn.recording {
        background: #e74c3c; color: white;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
        70% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); }
        100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
    }

    /* åº•éƒ¨æŒ‰é’® */
    .btn-submit {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 40px;
        border-radius: 50px;
        font-size: 1rem;
        letter-spacing: 1px;
        box-shadow: 0 5px 15px rgba(44, 62, 80, 0.2);
        transition: all 0.3s;
    }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(44, 62, 80, 0.3); color: white; }

    .btn-cancel {
        color: #999;
        text-decoration: none;
        margin-right: 20px;
        font-size: 0.9rem;
    }
    .btn-cancel:hover { color: #666; }
</style>

<div class="row justify-content-center">
    <div class="col-md-8">
        <a href="{% url 'teacher_dashboard' %}" class="btn-cancel mb-3 d-inline-block">
            &larr; è¿”å›æ‰¹æ”¹å°
        </a>

        <div class="card summary-card">
            <div class="card-header-styled">
                <h3 class="page-title">âœï¸ æ’°å†™æ€»è¯„ / Teacher's Summary</h3>
                <div class="sub-title">
                    å­¦å‘˜ï¼š<strong style="color:#333;">{{ checkin.student.username }}</strong> &nbsp;|&nbsp;
                    æ—¥æœŸï¼š{{ checkin.date|date:"Y.m.d" }}
                </div>
            </div>

            <div class="card-body p-4">
                <form id="summaryForm">
                    {% csrf_token %}

                    <div class="mb-4">
                        <label class="form-label fw-bold" style="color: #bfa15f;">ğŸ“ æ–‡å­—å¯„è¯­</label>
                        <textarea id="summary_text" name="summary_text" class="form-control" rows="6"
                                  placeholder="è¯·å†™ä¸‹å¯¹è¯¥å­¦å‘˜ä»Šæ—¥ç»ƒä¹ çš„æ•´ä½“è¯„ä»·ã€é¼“åŠ±æˆ–å»ºè®®..."
                                  style="background: #fafafa; border: 1px solid #eee;">{{ checkin.teacher_summary|default:'' }}</textarea>
                    </div>

                    <div class="mb-5">
                        <label class="form-label fw-bold" style="color: #bfa15f;">ğŸ™ï¸ è¯­éŸ³å¯„è¯­ (å¯é€‰)</label>

                        <div class="audio-recorder-box" id="recorderBox">
                            <button type="button" id="recBtn" class="rec-btn start" onclick="toggleRec()">
                                ğŸ™ï¸
                            </button>
                            <div id="recStatus" class="text-muted small">ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³</div>

                            <audio id="audioPreview" controls style="display:none; width: 100%; margin-top: 20px;"></audio>
                        </div>

                        {% if checkin.teacher_audio %}
                            <div class="mt-3 p-3 bg-light rounded border">
                                <small class="text-muted d-block mb-2">ğŸ’¿ å½“å‰å·²ä¿å­˜çš„å½•éŸ³ï¼š</small>
                                <audio controls src="{{ checkin.teacher_audio.url }}" class="w-100" style="height: 30px;"></audio>
                            </div>
                        {% endif %}
                    </div>

                    <div class="text-end border-top pt-4">
                        <a href="{% url 'teacher_dashboard' %}" class="btn-cancel">å–æ¶ˆ</a>
                        <button type="button" onclick="submitForm()" id="submitBtn" class="btn btn-submit">
                            ğŸ’¾ ä¿å­˜å‘å¸ƒ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= æ™ºèƒ½å½•éŸ³é€»è¾‘ (M4A/WebM å…¼å®¹) =================
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioBlob = null;
    let supportedMimeType = '';
    let fileExtension = 'webm'; // é»˜è®¤

    // é¡µé¢åŠ è½½æ—¶æ£€æµ‹æµè§ˆå™¨æ”¯æŒçš„æ ¼å¼
    document.addEventListener("DOMContentLoaded", function() {
        checkSupportedType();
    });

    function checkSupportedType() {
        if (typeof MediaRecorder === 'undefined') return;

        // ä¼˜å…ˆå°è¯• MP4/AAC (è‹¹æœè®¾å¤‡)
        if (MediaRecorder.isTypeSupported('audio/mp4')) {
            supportedMimeType = 'audio/mp4'; fileExtension = 'm4a';
        }
        // å…¶æ¬¡å°è¯• WebM (å®‰å“/Chrome)
        else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            supportedMimeType = 'audio/webm;codecs=opus'; fileExtension = 'webm';
        } else {
            supportedMimeType = 'audio/webm'; fileExtension = 'webm';
        }
        console.log(`ä½¿ç”¨æ ¼å¼: ${supportedMimeType}, åç¼€: .${fileExtension}`);
    }

    function toggleRec() {
        if(!isRecording) startRec();
        else stopRec();
    }

    async function startRec() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const options = supportedMimeType ? { mimeType: supportedMimeType } : {};

            mediaRecorder = new MediaRecorder(stream, options);
            audioChunks = [];
            mediaRecorder.start();

            // UI æ›´æ–°
            isRecording = true;
            const btn = document.getElementById('recBtn');
            btn.classList.remove('start');
            btn.classList.add('recording');
            btn.innerHTML = 'â– '; // åœæ­¢å›¾æ ‡

            document.getElementById('recorderBox').classList.add('recording');
            document.getElementById('recStatus').innerText = "æ­£åœ¨å½•éŸ³... (ç‚¹å‡»åœæ­¢)";
            document.getElementById('recStatus').style.color = "#e74c3c";

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                // ç”Ÿæˆ Blob
                audioBlob = new Blob(audioChunks, { type: supportedMimeType });

                // ç”Ÿæˆé¢„è§ˆé“¾æ¥
                const url = URL.createObjectURL(audioBlob);
                const audio = document.getElementById('audioPreview');
                audio.src = url;
                audio.style.display = 'block';
            };
        } catch(e) {
            alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚");
            console.error(e);
        }
    }

    function stopRec() {
        if(mediaRecorder) {
            mediaRecorder.stop();
            isRecording = false;

            // UI æ¢å¤
            const btn = document.getElementById('recBtn');
            btn.classList.remove('recording');
            btn.classList.add('start');
            btn.innerHTML = 'ğŸ™ï¸'; // é‡å½•å›¾æ ‡

            document.getElementById('recorderBox').classList.remove('recording');
            document.getElementById('recStatus').innerText = "å½•éŸ³å·²å®Œæˆ (ç‚¹å‡»è¯ç­’å¯é‡å½•)";
            document.getElementById('recStatus').style.color = "#666";
        }
    }

    // ================= è¡¨å•æäº¤é€»è¾‘ =================
    function submitForm() {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨ä¿å­˜...";

        const formData = new FormData();
        formData.append('summary_text', document.getElementById('summary_text').value);

        // å¦‚æœæœ‰æ–°å½•éŸ³ï¼Œæ·»åŠ åˆ°è¡¨å•
        if(audioBlob) {
            formData.append('summary_audio', audioBlob, `teacher_summary.${fileExtension}`);
        }

        // ä½¿ç”¨ fetch å‘é€è¯·æ±‚ (å› ä¸ºæ˜¯åŒæºé¡µé¢ï¼Œé€šå¸¸ä¼šè‡ªåŠ¨å¸¦ Cookie)
        // è·å– CSRF Token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url; // æˆåŠŸåè·³è½¬
            } else if (response.ok) {
                // å¦‚æœåç«¯æ²¡è¿”å› redirectï¼Œæˆ‘ä»¬æ‰‹åŠ¨è·³å› Dashboard
                window.location.href = "{% url 'teacher_dashboard' %}";
            } else {
                alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
                btn.disabled = false;
                btn.innerText = "ğŸ’¾ ä¿å­˜å‘å¸ƒ";
            }
        }).catch(error => {
            console.error('Error:', error);
            alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
            btn.disabled = false;
            btn.innerText = "ğŸ’¾ ä¿å­˜å‘å¸ƒ";
        });
    }
</script>

{% endblock %}