{% extends 'training/base.html' %}

{% block content %}

<style>
    /* =========================================
    1. åŸºç¡€é€šç”¨æ ·å¼ (ç«–å±é»˜è®¤)
    ========================================= */
    .exercise-content {
        overflow-x: hidden; color: #4a5568; font-size: 1.05rem; line-height: 1.9;
    }
    .exercise-content * { max-width: 100% !important; box-sizing: border-box !important; }
    .exercise-content img {
        height: auto !important; display: block !important; margin: 20px auto !important;
        border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .content-card {
        background: var(--card-bg); border-radius: 20px; padding: 30px;
        margin-bottom: 30px; box-shadow: var(--shadow-light); border: 1px solid rgba(0,0,0,0.02);
    }
    
    .exercise-title {
        font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.5rem;
        color: var(--primary-color); text-align: center; margin-bottom: 20px;
    }

    /* ç¤ºèŒƒéŸ³é¢‘ */
    .demo-audio-box {
        background: #fffdf5; border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 15px; padding: 20px; margin-top: 30px; margin-bottom: 10px;
    }
    .demo-label {
        font-size: 0.85rem; color: var(--accent-color); font-weight: 700;
        text-transform: uppercase; display: block; text-align: center; margin-bottom: 10px;
    }
    
    .speed-controls { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
    .speed-btn {
        background: white; border: 1px solid #ddd; border-radius: 20px; padding: 4px 12px;
        font-size: 0.8rem; color: #666;
    }
    .speed-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

    /* å½•éŸ³æ§åˆ¶å° */
    .recording-console {
        text-align: center; padding: 40px 20px;
        background: linear-gradient(135deg, #fffdf5 0%, #fff 100%);
        border: 1px dashed var(--accent-color);
    }

    .record-btn-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto 10px; }
    .record-btn {
        width: 100%; height: 100%; border-radius: 50%; border: none; background: white;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        align-items: center; justify-content: center; border: 2px solid #f0f0f0;
    }
    .record-btn.start { color: #e74c3c; }
    .record-btn.recording { background: #e74c3c; color: white; animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); transform: scale(1); }
        70% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); transform: scale(1.05); }
        100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); transform: scale(1); }
    }
    .status-text { color: #999; font-size: 0.9rem; min-height: 24px; margin-bottom: 0; }

    /* è¯•å¬åŒº & æŒ‰é’® */
    .review-area { display: none; padding: 20px; background: #fdfbf7; border-radius: 15px; border: 1px dashed var(--accent-color); }
    .action-buttons-row { display: flex; justify-content: space-between; gap: 8px; margin-top: 10px; }
    .btn-round {
        border-radius: 50px; font-size: 0.85rem; padding: 10px 0; border: none; font-weight: 600;
        white-space: nowrap; flex: 1; display: flex; justify-content: center; align-items: center; gap: 4px;
    }
    .btn-skip { background: #f5f5f5; color: #999; border: 1px solid #eee; }
    .btn-retry { background: #fff; color: var(--accent-color); border: 1px solid var(--accent-color); }
    .btn-upload { background: linear-gradient(135deg, var(--accent-color), #bfa15f); color: white; flex: 1.2; }

    /* å…¶ä»–å…ƒç´  */
    .existing-hint { background: #e8f5e9; color: #2e7d32; padding: 8px 15px; border-radius: 50px; font-size: 0.85rem; display: inline-block; margin-bottom: 20px; }
    .teacher-area { background: linear-gradient(to bottom right, #fdfbf7, #fffbf0); border-radius: 20px; padding: 30px; margin-top: 30px; }
    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2050; }
    .grace-toast { background: rgba(255, 255, 255, 0.95); padding: 12px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; transform: translateY(-100px); opacity: 0; transition: all 0.5s; }
    .grace-toast.show { transform: translateY(0); opacity: 1; }
    .back-link { color: var(--text-secondary); display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; }
    .wechat-landscape-btn {
position: fixed;
bottom: 20px;
right: 20px;
z-index: 3000;
padding: 12px 18px;
border-radius: 50px;
border: none;
background: linear-gradient(135deg, #d4af37, #b8962e);
color: #fff;
font-size: 0.9rem;
font-weight: 600;
}

    /* =========================================
    2. æ‰‹æœºç«–å± (Portrait) ç‰¹å®šè°ƒæ•´
    ========================================= */
    @media (max-width: 768px) {
        body { padding-bottom: 200px; }
        .practice-dock {
            max-height: 40vh; overflow-y: auto; position: fixed; bottom: 0; left: 0; right: 0;
            background: #ffffff; border-top: 1px solid #eee; box-shadow: 0 -8px 25px rgba(0,0,0,0.08);
            z-index: 999; padding: 10px 12px 15px;
        }
        .dock-demo { margin: 0 0 8px 0; padding: 10px; }
        .recording-console { padding: 15px 10px 10px; margin-bottom: 0; background: transparent; border: none; }
        .record-btn { width: 80px; height: 80px; }
        #landscape-gallery-container { display: none; } /* ç«–å±éšè—æ¨ªå±ç”»å»Š */
    }

    /* =========================================
    3. å¾®ä¿¡æ¨ªå±æ¨¡å¼ - æ—‹è½¬å¼
    åœ¨ç«–å±æ‰‹æœºä¸Šæ¨¡æ‹Ÿæ¨ªå±æ•ˆæœï¼Œç”¨æˆ·æŠŠæ‰‹æœºæ¨ªè¿‡æ¥çœ‹
    ========================================= */

/* æ—‹è½¬å®¹å™¨ - æ ¸å¿ƒ */
.wechat-landscape-wrapper {
display: none;
}

body.landscape-mode {
overflow: hidden !important;
background: #000 !important;
}

body.landscape-mode .wechat-landscape-wrapper {
display: block !important;
position: fixed !important;
top: 0 !important;
/* left, width, height ç”± JS åŠ¨æ€è®¾ç½® */
transform: rotate(90deg) !important;
transform-origin: top left !important;
background: #000 !important;
z-index: 9999 !important;
overflow: hidden !important;
}

/* ç¡®ä¿æ—‹è½¬å®¹å™¨å†…çš„æŒ‰é’®å¯ç‚¹å‡» */
.wechat-landscape-wrapper .wl-dock,
.wechat-landscape-wrapper .wl-dock * {
pointer-events: auto !important;
}

/* éšè—åŸæœ‰å†…å®¹ */
body.landscape-mode .navbar,
body.landscape-mode footer,
body.landscape-mode .row.justify-content-center,
body.landscape-mode #wechatLandscapeBtn,
body.landscape-mode #landscape-gallery-container {
display: none !important;
}

/* æ—‹è½¬å®¹å™¨å†…çš„å¸ƒå±€ */
.wechat-landscape-wrapper .wl-content {
display: flex;
width: 100%;
height: 100%;
}

/* å·¦ä¾§ä¹è°±åŒº */
.wechat-landscape-wrapper .wl-sheet {
flex: 1;
background: #222;
display: flex;
align-items: center;
justify-content: center;
overflow: auto;
padding: 10px;
}

.wechat-landscape-wrapper .wl-sheet img {
max-width: 100%;
max-height: 100%;
object-fit: contain;
background: white;
border-radius: 5px;
}

.wechat-landscape-wrapper .wl-sheet .no-sheet {
color: #666;
font-size: 14px;
}

/* å³ä¾§å½•éŸ³åŒº */
.wechat-landscape-wrapper .wl-dock {
width: 280px;
background: #fff;
display: flex;
flex-direction: column;
justify-content: center;
padding: 20px 15px;
box-shadow: -5px 0 20px rgba(0,0,0,0.3);
}

/* æ— ä¹è°±æ—¶å½•éŸ³åŒºå±…ä¸­ */
.wechat-landscape-wrapper.no-sheet .wl-sheet {
display: none;
}
.wechat-landscape-wrapper.no-sheet .wl-dock {
width: 100%;
max-width: 400px;
margin: 0 auto;
}

/* ç¤ºèŒƒéŸ³é¢‘ */
.wechat-landscape-wrapper .wl-demo {
background: #fffdf5;
border-radius: 12px;
padding: 15px;
margin-bottom: 20px;
}

.wechat-landscape-wrapper .wl-demo-label {
font-size: 12px;
color: #d4af37;
font-weight: 600;
text-align: center;
margin-bottom: 8px;
}

.wechat-landscape-wrapper .wl-demo audio {
width: 100%;
height: 36px;
}

.wechat-landscape-wrapper .wl-speed-btns {
display: flex;
justify-content: center;
gap: 8px;
margin-top: 8px;
}

.wechat-landscape-wrapper .wl-speed-btn {
padding: 4px 10px;
font-size: 12px;
border: 1px solid #ddd;
border-radius: 15px;
background: white;
color: #666;
}

.wechat-landscape-wrapper .wl-speed-btn.active {
background: #d4af37;
color: white;
border-color: #d4af37;
}

/* å½•éŸ³æŒ‰é’® */
.wechat-landscape-wrapper .wl-record-area {
text-align: center;
}

.wechat-landscape-wrapper .wl-record-btn {
width: 90px;
height: 90px;
border-radius: 50%;
border: 2px solid #f0f0f0;
background: white;
box-shadow: 0 5px 20px rgba(0,0,0,0.1);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
margin: 0 auto;
cursor: pointer;
}

.wechat-landscape-wrapper .wl-record-btn .icon {
font-size: 28px;
}

.wechat-landscape-wrapper .wl-record-btn .label {
font-size: 12px;
color: #e74c3c;
margin-top: 4px;
}

.wechat-landscape-wrapper .wl-record-btn.recording {
background: #e74c3c;
animation: pulse-rec 1.5s infinite;
}

.wechat-landscape-wrapper .wl-record-btn.recording .icon,
.wechat-landscape-wrapper .wl-record-btn.recording .label {
color: white;
}

@keyframes pulse-rec {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

/* æ¨ªå±è¯•å¬åŒº */
.wechat-landscape-wrapper .wl-review-area {
margin-top: 15px;
padding: 15px;
background: #fdfbf7;
border-radius: 12px;
border: 1px dashed #d4af37;
}

.wechat-landscape-wrapper .wl-action-btns {
display: flex;
gap: 10px;
justify-content: center;
}

.wechat-landscape-wrapper .wl-btn {
padding: 10px 16px;
border-radius: 25px;
font-size: 13px;
font-weight: 600;
border: none;
cursor: pointer;
white-space: nowrap;
}

.wechat-landscape-wrapper .wl-btn-retry {
background: #fff;
color: #d4af37;
border: 1px solid #d4af37;
}

.wechat-landscape-wrapper .wl-btn-upload {
background: linear-gradient(135deg, #d4af37, #bfa15f);
color: white;
flex: 1;
}

.wechat-landscape-wrapper .wl-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}

/* å…³é—­æŒ‰é’® */
.wechat-landscape-wrapper .wl-close {
position: absolute;
top: 10px;
right: 10px;
width: 36px;
height: 36px;
background: rgba(255,255,255,0.9);
border: none;
border-radius: 50%;
font-size: 20px;
cursor: pointer;
z-index: 10;
}

/* æç¤ºæ–‡å­— */
.wechat-landscape-wrapper .wl-tip {
position: absolute;
bottom: 10px;
left: 50%;
transform: translateX(-50%);
font-size: 11px;
color: #999;
background: rgba(0,0,0,0.5);
padding: 4px 12px;
border-radius: 10px;
}


@media (orientation: landscape) {

    body {
        background: #000 !important;
        padding: 0 !important;
        margin: 0 !important;
        overflow: hidden !important;
    }

    /* éšè—éæ ¸å¿ƒåŒºåŸŸ */
    .navbar, footer, .back-link,
    .exercise-title, .existing-hint,
    .teacher-area, #history-player-area,
    #original-content, .mt-4.text-center,
    #wechatLandscapeBtn {
        display: none !important;
    }

    /* é‡Šæ”¾å¸ƒå±€ï¼Œä¸ç¦ç”¨ pointer-events */
    .row, .col-md-10, .col-lg-8, .content-card {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
        position: static !important;
    }

    /* å·¦ï¼šè°±å­ */
    #landscape-gallery-container {
        display: flex !important;
        position: fixed;
        inset: 0 320px 0 0;
        background: #111;
        align-items: center;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        z-index: 1000;
    }

    .landscape-img-slide {
        flex: 0 0 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        scroll-snap-align: center;
        padding: 12px;
    }

    .landscape-img-slide img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        background: #fff;
        border-radius: 4px;
    }

    /* å³ï¼šå½•éŸ³ Dock */
    .practice-dock {
        position: fixed !important;
        top: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        left: auto !important;
        width: 320px !important;
        height: 100vh !important;
        min-height: 100vh !important;
        display: flex !important;
        flex-direction: column;
        justify-content: center;
        align-items: stretch;
        background: #fff !important;
        padding: 40px 12px 12px 12px;
        z-index: 1001;
        overflow: hidden;
    }
    
    /* ç¡®ä¿ .practice-dock å†…çš„å…ƒç´ æ­£å¸¸æ˜¾ç¤º */
    .practice-dock .dock-demo {
        margin-bottom: 15px !important;
        padding: 12px !important;
        background: #fffdf5 !important;
        flex-shrink: 0;
    }
    
    .practice-dock .recording-console {
        display: block !important;
        padding: 12px 8px !important;
        background: #fff !important;
        border: none !important;
        margin: 0 !important;
        flex-shrink: 0;
    }
    
    .practice-dock .content-card.recording-console {
        background: #fff !important;
        padding: 12px 8px !important;
    }
    
    .practice-dock .record-btn-wrapper {
        width: 80px !important;
        height: 80px !important;
        margin: 12px auto 8px !important;
    }
    
    .practice-dock .record-btn {
        width: 80px !important;
        height: 80px !important;
        font-size: 0.75rem !important;
    }
    
    .practice-dock .speed-controls {
        margin-top: 8px !important;
        gap: 6px !important;
    }
    
    .practice-dock .speed-btn {
        padding: 3px 8px !important;
        font-size: 0.7rem !important;
    }

    /* æ¨ªå±çŠ¶æ€æç¤º */
    .practice-dock::before {
        content: "æ¨ªå±ç»ƒä¹ æ¨¡å¼";
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: #bbb;
        letter-spacing: 2px;
    }

    .toast-container {
        top: 8px;
        z-index: 2000;
    }
}
@media (orientation: landscape) and (max-width: 1024px) {
    /* âœ… å…³é”®ä¿®å¤ï¼šæ˜ç¡®å…è®¸ Dock åŠå…¶å­å…ƒç´ æ¥æ”¶ç‚¹å‡» */
    .practice-dock,
    .practice-dock * {
        pointer-events: auto !important;
    }

    /* â›” åŒæ—¶æ˜ç¡®ç¦æ­¢å·¦ä¾§è°±å­åŒºåŸŸå¹²æ‰°å³ä¾§ç‚¹å‡» */
    #landscape-gallery-container {
        pointer-events: auto;
    }
        
        /* 1. å¼ºåˆ¶é‡ç½® Bodyï¼šè§£å†³ç´«è‰²èƒŒæ™¯é—®é¢˜ */
        body { 
            background: #000 !important; /* èƒŒæ™¯è®¾ä¸ºé»‘è‰²ï¼Œæ›´é€‚åˆçœ‹è°± */
            padding: 0 !important; 
            margin: 0 !important;
            overflow: hidden !important; 
        }

        /* 2. éšè—ä¸éœ€è¦çš„å…ƒç´  (æ ‡é¢˜ã€æ­£æ–‡ã€å¯¼èˆªç­‰) */
        .navbar, footer, .back-link,
        .exercise-title, .existing-hint,
        .teacher-area, #history-player-area,
        #original-content, .mt-4.text-center,
        #wechatLandscapeBtn {
            display: none !important;
        }

        /* 3. å…³é”®ä¿®å¤ï¼šè®©åŸæœ‰å®¹å™¨"éšå½¢"ä½†ä¸å½±å“å­å…ƒç´ å›ºå®šå®šä½ */
        /* ä¸è¦ç”¨ display:none éšè— .content-cardï¼Œå¦åˆ™é‡Œé¢çš„ dock ä¼šæ¶ˆå¤± */
        .row, .col-md-10, .col-lg-8, .content-card {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 100% !important;
            min-height: 0 !important;
            position: static !important; /* é¿å…ç›¸å¯¹å®šä½å›°ä½å­å…ƒç´  */
            pointer-events: auto; /* ä¿æŒæ§ä»¶å¯ç‚¹å‡» */
        }

        /* 4. å·¦ä¾§ï¼šå›¾ç‰‡ç”»å»Š */
        #landscape-gallery-container {
            display: flex !important;
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: calc(100% - 320px); /* ç•™å‡ºå³ä¾§ 320px ç»™åŠŸèƒ½åŒº */
            background: #222; /* æ·±è‰²èƒŒæ™¯è¡¬æ‰˜ä¹è°± */
            align-items: center;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            z-index: 1000;
            pointer-events: auto;
        }

        .landscape-img-slide {
            flex: 0 0 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            scroll-snap-align: center;
            padding: 10px;
        }

        .landscape-img-slide img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain; /* å®Œæ•´æ˜¾ç¤ºå›¾ç‰‡ */
            border-radius: 5px;
            box-shadow: none;
            background: white; /* å¦‚æœä¹è°±æ˜¯é€æ˜pngï¼ŒåŠ ä¸ªç™½åº• */
        }
        
        .no-img-placeholder { width: 100%; text-align: center; color: #999; }

        /* 5. å³ä¾§ï¼šåŠŸèƒ½åŒº (Dock) */
        .practice-dock {
            display: flex !important;
            flex-direction: column;
            justify-content: center;
            align-items: stretch;
            
            position: fixed !important;
            top: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            left: auto !important;
            width: 320px !important;
            height: 100vh !important;
            min-height: 100vh !important;
            max-height: 100vh !important;
            
            background: #fff !important;
            border-left: 1px solid #333;
            border-top: none;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            padding: 40px 12px 12px 12px;
            overflow: hidden;
            z-index: 1001;
            pointer-events: auto;
        }

        /* æ¨ªå±ä¸‹è°ƒæ•´æ§ä»¶ - ç´§å‡‘å¸ƒå±€ */
        .practice-dock .dock-demo { 
            margin-bottom: 15px !important; 
            padding: 12px !important;
            background: #fffdf5 !important;
            flex-shrink: 0;
        }
        
        .practice-dock .recording-console { 
            padding: 12px 8px !important; 
            border: none !important; 
            background: #fff !important;
            display: block !important;
            min-height: auto !important;
            margin: 0 !important;
            flex-shrink: 0;
        }
        
        .practice-dock .record-btn-wrapper { 
            width: 80px !important; 
            height: 80px !important; 
            margin: 12px auto 8px !important;
            display: block !important;
        }
        
        .practice-dock .record-btn { 
            width: 80px !important; 
            height: 80px !important;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            background: white !important;
            font-size: 0.75rem !important;
        }
        
        .practice-dock .speed-controls {
            margin-top: 8px !important;
            gap: 6px !important;
        }
        
        .practice-dock .speed-btn {
            padding: 3px 8px !important;
            font-size: 0.7rem !important;
        }
        
        .practice-dock #recordBtnContainer {
            display: block !important;
            visibility: visible !important;
        }
        
        /* ç¡®ä¿ Toast ä¾ç„¶å¯è§ */
        .toast-container { display: block !important; top: 10px; z-index: 2000; } 
    }
</style>

<div class="toast-container">
    <div id="graceToast" class="grace-toast">
        <span id="toastIcon" style="font-size: 1.2rem;">âœ¨</span>
        <span id="toastMsg" style="font-weight: 500; font-size: 0.95rem;"></span>
    </div>
</div>

<div id="landscape-gallery-container">
    <div class="no-img-placeholder">æš‚æ— å›¾ç‰‡ï¼Œè¯·åœ¨ç«–å±æŸ¥çœ‹æ–‡å­—å†…å®¹</div>
</div>

<!-- å¾®ä¿¡æ¨ªå±æ—‹è½¬å®¹å™¨ - æ‰‹æœºç«–ç€æ‹¿ï¼Œå†…å®¹æ—‹è½¬90åº¦ -->
<div class="wechat-landscape-wrapper" id="wechatLandscapeWrapper">
    <button class="wl-close" id="wlCloseBtn">âœ•</button>
    <div class="wl-content">
        <div class="wl-sheet" id="wlSheetArea">
            <!-- ä¹è°±å›¾ç‰‡ä¼šåŠ¨æ€å¡«å…… -->
        </div>
        <div class="wl-dock" id="wlDock">
            {% if exercise.demo_audio %}
            <div class="wl-demo">
                <div class="wl-demo-label">â™« è€å¸ˆç¤ºèŒƒ</div>
                <audio id="wlDemoAudio" controls src="{{ exercise.demo_audio.url }}"></audio>
                <div class="wl-speed-btns">
                    <button class="wl-speed-btn" data-speed="0.75">0.75x</button>
                    <button class="wl-speed-btn active" data-speed="1.0">1.0x</button>
                    <button class="wl-speed-btn" data-speed="1.25">1.25x</button>
                </div>
            </div>
            {% endif %}
            <div class="wl-record-area">
                <!-- å½•éŸ³æŒ‰é’® -->
                <button class="wl-record-btn" id="wlRecordBtn">
                    <span class="icon">ğŸ™ï¸</span>
                    <span class="label">å¼€å§‹å½•éŸ³</span>
                </button>
                
                <!-- æ¨ªå±è¯•å¬åŒº - å½•éŸ³å®Œæˆåæ˜¾ç¤º -->
                <div class="wl-review-area" id="wlReviewArea" style="display:none;">
                    <audio id="wlAudioPreview" controls style="width:100%; height:36px; margin-bottom:12px;"></audio>
                    <div class="wl-action-btns">
                        <button class="wl-btn wl-btn-retry" id="wlRetryBtn">ğŸ”„ é‡å½•</button>
                        <button class="wl-btn wl-btn-upload" id="wlUploadBtn">ğŸ“š æ›´æ–°åˆ°ä½œä¸šæœ¬</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="wl-tip">ğŸ“± è¯·å°†æ‰‹æœºæ¨ªè¿‡æ¥æŸ¥çœ‹</div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <button id="wechatLandscapeBtn" class="wechat-landscape-btn" style="display:none;">
ğŸ“± æ¨ªå±ç»ƒä¹ 
</button>

        <a href="{% url 'student_dashboard' %}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            è¿”å›ç»ƒä¹ åˆ—è¡¨
        </a>

        <div class="content-card">
            <h1 class="exercise-title">{{ exercise.title }}</h1>

            {% if record %}
                <div class="text-center">
                    <div class="existing-hint">
                        âœ… æœ¬å‘¨å·²å®Œæˆ ({{ record.submitted_at|date:"m-d H:i" }})
                        {% if record.student_audio %}
                            <br><small>å†æ¬¡ä¸Šä¼ å°†è¦†ç›–æ—§å½•éŸ³</small>
                        {% else %}
                            <br><small>ï¼ˆæ‚¨ä¹‹å‰é€‰æ‹©äº†æ”¾å¼ƒå½•éŸ³ï¼‰</small>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <div id="original-content" class="exercise-content mt-4">
                {{ exercise.content|safe }}
            </div>

            {% if exercise.content_url %}
                <div class="mt-4 text-center">
                    <a href="{{ exercise.content_url }}" target="_blank" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
                        ğŸ”— æŸ¥çœ‹åŸæ–‡é“¾æ¥
                    </a>
                </div>
            {% endif %}
            
            <div class="practice-dock">

                {% if exercise.demo_audio %}
                <div id="demoContainer" class="demo-audio-box dock-demo">
                    <span class="demo-label">â™« è€å¸ˆç¤ºèŒƒ</span>
                    <audio id="demoAudioPlayer" controls src="{{ exercise.demo_audio.url }}" class="w-100"></audio>

                    <div class="speed-controls">
                        <button class="speed-btn" onclick="changeSpeed(0.75)">0.75x</button>
                        <button class="speed-btn active" onclick="changeSpeed(1.0)">1.0x</button>
                        <button class="speed-btn" onclick="changeSpeed(1.25)">1.25x</button>
                        <button class="speed-btn" onclick="changeSpeed(1.5)">1.5x</button>
                    </div>
                </div>
                {% endif %}

                <div class="content-card recording-console dock-record">
                    <div id="recordBtnContainer">
                        <div class="record-btn-wrapper">
                            <button id="recordMainBtn" class="record-btn start" onclick="toggleRecording()">
                                <span id="btnIcon" style="font-size: 24px;">ğŸ™ï¸</span>
                                <span id="btnLabel" class="btn-text">å¼€å§‹å½•éŸ³</span>
                            </button>
                        </div>
                        <p id="statusText" class="status-text" style="display: none;">å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢</p>
                    </div>
                    
                    <div id="reviewArea" class="review-area">
                        <h6 style="color:#666; margin-bottom:10px; text-align:center;">ğŸ§ è¯•å¬æœ¬æ¬¡å½•éŸ³</h6>
                        <audio id="audioPreview" controls style="width:100%; margin-bottom:15px;"></audio>

                        <div class="action-buttons-row">
                            <button class="btn-round btn-retry" onclick="resetToRecordState()">ğŸ”„ é‡å½•</button>
                            <button class="btn-round btn-upload" onclick="uploadBest()">ğŸ“š æ›´æ–°åˆ°ä½œä¸šæœ¬</button>
                        </div>
                    </div>
                </div>

            </div>
            {% if record and record.student_audio %}
            <div id="history-player-area" class="mt-4" style="border-top:1px solid #eee; padding-top:20px;">
                <p class="text-muted small mb-2">å½“å‰æœ¬å‘¨æœ€ä½³ ({{ record.submitted_at|date:"m-d H:i" }})</p>
                <audio controls src="{{ record.student_audio.url }}" class="w-100"></audio>
            </div>
            {% endif %}
        </div>

        {% if record and record.teacher_comment_text %}
        <div class="teacher-area">
            <div class="d-flex align-items-center mb-3" style="color: #bfa15f;">
                <span style="font-size: 1.2rem; margin-right: 10px;">âœ¦</span>
                <span style="font-family: 'Cinzel', serif; font-weight: 700;">TEACHER'S NOTE</span>
            </div>
            <p style="white-space: pre-wrap; line-height: 1.8; color: #555;">{{ record.teacher_comment_text }}</p>
            {% if record.teacher_comment_audio %}
                <div class="mt-3">
                    <small class="text-muted d-block mb-1">è¯­éŸ³ç‚¹è¯„ï¼š</small>
                    <audio controls src="{{ record.teacher_comment_audio.url }}" class="w-100"></audio>
                </div>
            {% endif %}
        </div>
        {% endif %}

    </div>
</div>

<script>
    // === å…¨å±€å˜é‡ ===
    let currentAudioBlob = null;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let supportedMimeType = 'audio/webm';
    let fileExtension = 'webm';

    // === å·¥å…·å‡½æ•° ===
    function isWeChat() {
        return /MicroMessenger/i.test(navigator.userAgent);
    }

    // === 1. åˆå§‹åŒ– ===
    document.addEventListener("DOMContentLoaded", function() {
        checkSupportedType();
        setupLandscapeImages(); // æå–å›¾ç‰‡

        // æ ·å¼æ¸…ç†
        var container = document.querySelector('.exercise-content');
        if (container) {
            container.querySelectorAll('*').forEach(function(el) {
                if (el.getAttribute('width')) el.removeAttribute('width');
                if (el.style.width) el.style.width = 'auto';
                if (el.tagName === 'IMG') { el.style.maxWidth = '100%'; el.style.height = 'auto'; }
            });
        }
    });

    // æå–æ¨ªå±å›¾ç‰‡é€»è¾‘
    function setupLandscapeImages() {
    const originalContent = document.getElementById('original-content');
    const galleryContainer = document.getElementById('landscape-gallery-container');
    const images = originalContent ? originalContent.querySelectorAll('img') : [];

    if (!galleryContainer) return;

    if (images.length === 0) {
        // æ— å›¾ç‰‡æ—¶æ·»åŠ æ ‡è®°ç±»ï¼Œè®©å½•éŸ³åŒºå±…ä¸­
        document.body.classList.add('no-images');
        galleryContainer.style.display = 'none';
        return;
    }

    // æœ‰å›¾ç‰‡æ—¶ç¡®ä¿ç§»é™¤æ ‡è®°ç±»
    document.body.classList.remove('no-images');
    
    galleryContainer.innerHTML = '';
    images.forEach(img => {
        const slideDiv = document.createElement('div');
        slideDiv.className = 'landscape-img-slide';
        const newImg = img.cloneNode(true);
        newImg.removeAttribute('width');
        newImg.removeAttribute('height');
        slideDiv.appendChild(newImg);
        galleryContainer.appendChild(slideDiv);
    });
}

    // === 2. æ ¼å¼æ£€æµ‹ ===
    function checkSupportedType() {
        if (typeof MediaRecorder === 'undefined') return;
        if (MediaRecorder.isTypeSupported('audio/mp4')) {
            supportedMimeType = 'audio/mp4'; fileExtension = 'm4a';
        } else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            supportedMimeType = 'audio/webm;codecs=opus'; fileExtension = 'webm';
        } else {
            supportedMimeType = 'audio/webm'; fileExtension = 'webm';
        }
    }

    // === 3. ç¤ºèŒƒéŸ³é¢‘æ§åˆ¶ ===
    function changeSpeed(speed) {
        const audio = document.getElementById('demoAudioPlayer');
        if (audio) {
            audio.playbackRate = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText.includes(speed)) btn.classList.add('active');
            });
        }
    }

    // === 4. å½•éŸ³é€»è¾‘ (ä¿æŒéŸ³è´¨ä¿®å¤é…ç½®) ===
    const mainBtn = document.getElementById('recordMainBtn');
    const btnIcon = document.getElementById('btnIcon');
    const btnLabel = document.getElementById('btnLabel');
    const statusText = document.getElementById('statusText');
    const reviewArea = document.getElementById('reviewArea');
    const demoContainer = document.getElementById('demoContainer');
    const recordBtnContainer = document.getElementById('recordBtnContainer');
    
    // å½•éŸ³æ—¶é•¿è·Ÿè¸ª
    let recordingStartTime = null;
    let recordingDuration = 0;
    let recordingTimer = null;
    const AUTO_UPLOAD_MIN_SECONDS = 10; // è¶…è¿‡10ç§’è‡ªåŠ¨ä¸Šä¼ 

    function toggleRecording() {
        if (!isRecording) startRecording();
        else stopRecording();
    }

    async function startRecording() {
        try {
            // å…³é—­æ‰€æœ‰è‡ªåŠ¨éŸ³é¢‘å¤„ç†ï¼Œä¿ç•™åŸå§‹å£°éŸ³
            const audioConstraints = {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
                channelCount: 1
            };

            const stream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints });

            // è®¾ç½®é«˜æ¯”ç‰¹ç‡
            const options = {
                mimeType: supportedMimeType,
                audioBitsPerSecond: 128000 
            };

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMimeType });
            }

            audioChunks = [];
            mediaRecorder.start();
            
            // å¼€å§‹è®¡æ—¶
            recordingStartTime = Date.now();
            recordingDuration = 0;
            
            // æ›´æ–°å½•éŸ³æ—¶é•¿æ˜¾ç¤º
            recordingTimer = setInterval(() => {
                recordingDuration = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(recordingDuration / 60);
                const seconds = recordingDuration % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                statusText.innerText = `å½•éŸ³ä¸­... ${timeStr}`;
            }, 1000);

            isRecording = true;
            mainBtn.className = 'record-btn recording';
            btnIcon.innerText = 'â– ';
            btnLabel.innerText = 'åœæ­¢';
            statusText.style.display = 'block';
            statusText.innerText = "å½•éŸ³ä¸­... 0:00";
            statusText.style.color = "#e74c3c";
            
            // åŒæ­¥æ—‹è½¬å®¹å™¨å½•éŸ³æŒ‰é’®çŠ¶æ€
            if (typeof updateWlRecordBtn === 'function') updateWlRecordBtn();

            const demoAudio = document.getElementById('demoAudioPlayer');
            if(demoAudio) demoAudio.pause();
            reviewArea.style.display = 'none';

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = async () => {
                // åœæ­¢è®¡æ—¶
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                recordingDuration = Math.floor((Date.now() - recordingStartTime) / 1000);
                
                currentAudioBlob = new Blob(audioChunks, { type: supportedMimeType });
                const audioUrl = URL.createObjectURL(currentAudioBlob);

                document.getElementById('audioPreview').src = audioUrl;
                
                // === åŒæ­¥æ›´æ–°æ¨ªå±è¯•å¬åŒº ===
                const wlReviewArea = document.getElementById('wlReviewArea');
                const wlAudioPreview = document.getElementById('wlAudioPreview');
                const wlRecordBtnEl = document.getElementById('wlRecordBtn');
                if (wlReviewArea && wlAudioPreview) {
                    wlAudioPreview.src = audioUrl;
                }

                stream.getTracks().forEach(track => track.stop());
                
                // === æ ¸å¿ƒé€»è¾‘ï¼šå½•éŸ³è¶…è¿‡10ç§’è‡ªåŠ¨ä¸Šä¼  ===
                if (recordingDuration >= AUTO_UPLOAD_MIN_SECONDS) {
                    // è‡ªåŠ¨ä¸Šä¼ 
                    showToast(`å½•éŸ³ ${recordingDuration} ç§’ï¼Œæ­£åœ¨è‡ªåŠ¨ä¿å­˜...`, "loading");
                    autoUploadRecording();
                } else {
                    // ä¸è¶³10ç§’ï¼Œæ˜¾ç¤ºè¯•å¬åŒºè®©ç”¨æˆ·é€‰æ‹©
                    if(demoContainer) demoContainer.style.display = 'none';
                    recordBtnContainer.style.display = 'none';
                    reviewArea.style.display = 'block';
                    
                    if (wlReviewArea) {
                        wlReviewArea.style.display = 'block';
                        if (wlRecordBtnEl) wlRecordBtnEl.style.display = 'none';
                    }
                    
                    showToast(`å½•éŸ³ ${recordingDuration} ç§’ï¼Œä¸è¶³10ç§’ï¼Œè¯·é‡å½•æˆ–æ‰‹åŠ¨ä¸Šä¼ `, "error");
                }
            };
        } catch (err) {
            console.error(err);
            let errorMsg = "æ— æ³•è®¿é—®éº¦å…‹é£";
            
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                errorMsg = "è¯·å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£æƒé™";
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                errorMsg = "æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡";
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                errorMsg = "éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨";
            } else if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
                errorMsg = "éº¦å…‹é£ä¸æ”¯æŒæ‰€éœ€è®¾ç½®";
            } else if (err.name === 'NotSupportedError' || err.name === 'TypeError') {
                errorMsg = "æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ HTTPS æˆ– localhost";
            }
            
            showToast(errorMsg, "error");
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            isRecording = false;
            mainBtn.className = 'record-btn start';
            btnIcon.innerText = 'ğŸ™ï¸';
            
            // åŒæ­¥æ—‹è½¬å®¹å™¨å½•éŸ³æŒ‰é’®çŠ¶æ€
            if (typeof updateWlRecordBtn === 'function') updateWlRecordBtn();
            btnLabel.innerText = 'å¼€å§‹å½•éŸ³';
            statusText.style.display = 'none';
        }
    }

    function stopRecording() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            isRecording = false;
            mainBtn.className = 'record-btn start';
            btnIcon.innerText = 'ğŸ™ï¸';
            btnLabel.innerText = 'é‡å½•';
            
            // åŒæ­¥æ—‹è½¬å®¹å™¨å½•éŸ³æŒ‰é’®çŠ¶æ€
            if (typeof updateWlRecordBtn === 'function') updateWlRecordBtn();
        }
    }
    
    function resetToRecordState() {
        currentAudioBlob = null;
        reviewArea.style.display = 'none';
        if(demoContainer) demoContainer.style.display = 'block';
        recordBtnContainer.style.display = 'block';
        statusText.style.display = 'none';
        statusText.innerText = "";
        mainBtn.className = 'record-btn start';
        btnIcon.innerText = 'ğŸ™ï¸';
        btnLabel.innerText = 'å¼€å§‹å½•éŸ³';
    }
    
    // === è‡ªåŠ¨ä¸Šä¼ å½•éŸ³ï¼ˆå½•éŸ³è¶…è¿‡10ç§’æ—¶è§¦å‘ï¼‰===
    function autoUploadRecording() {
        if (!currentAudioBlob) return;

        const formData = new FormData();
        const timestamp = new Date().getTime();
        formData.append('audio_file', currentAudioBlob, `best_${timestamp}.${fileExtension}`);
        formData.append('exercise_id', '{{ exercise.id }}');

        fetch('/api/upload_practice/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                let msg = "âœ… ç»ƒä¹ å®Œæˆï¼å·²è‡ªåŠ¨ä¿å­˜";
                if (data.exp_earned) {
                    msg += ` (+${data.exp_earned} XP)`;
                }
                showToast(msg, "success");
                setTimeout(() => {
                    window.location.href = "{% url 'student_dashboard' %}";
                }, 1500);
            } else {
                showToast("è‡ªåŠ¨ä¿å­˜å¤±è´¥: " + data.msg, "error");
                // æ˜¾ç¤ºè¯•å¬åŒºè®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
                if(demoContainer) demoContainer.style.display = 'none';
                recordBtnContainer.style.display = 'none';
                reviewArea.style.display = 'block';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showToast("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ ", "error");
            // æ˜¾ç¤ºè¯•å¬åŒºè®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
            if(demoContainer) demoContainer.style.display = 'none';
            recordBtnContainer.style.display = 'none';
            reviewArea.style.display = 'block';
        });
    }

    // === 5. ä¸Šä¼ å½•éŸ³åˆ°ä½œä¸šæœ¬ ===
    function uploadBest() {
        if (!currentAudioBlob) return;
        const btn = document.querySelector('.btn-upload'); 
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "ä¸Šä¼ ä¸­...";

        const formData = new FormData();
        const timestamp = new Date().getTime();
        formData.append('audio_file', currentAudioBlob, `best_${timestamp}.${fileExtension}`);
        formData.append('exercise_id', '{{ exercise.id }}');

        fetch('/api/upload_practice/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast("ğŸ‰ " + data.msg, "success");
                setTimeout(() => {
                    window.location.href = "{% url 'student_dashboard' %}";
                }, 1500);
            } else {
                showToast("ä¸Šä¼ å¤±è´¥: " + data.msg, "error");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        })
        .catch(err => {
            showToast("ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•", "error");
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }

    function showToast(message, type='success') {
        const toast = document.getElementById('graceToast');
        const msg = document.getElementById('toastMsg');
        const icon = document.getElementById('toastIcon');
        msg.innerText = message;
        icon.innerText = type === 'error' ? 'âš ï¸' : 'âœ¨';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    // æ¨ªå±æ—¶é˜²æ­¢é¡µé¢è¯¯æ»šåŠ¨
window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        if (window.matchMedia("(orientation: landscape)").matches) {
            window.scrollTo(0, 0);
        }
    }, 300);
});
function handleOrientationMode() {
    // å¾®ä¿¡ç¯å¢ƒä¸‹ï¼Œå¦‚æœå·²ç»æ‰‹åŠ¨è¿›å…¥æ¨ªå±æ¨¡å¼ï¼Œå°±ä¸è¦è‡ªåŠ¨å¤„ç†
    if (isWeChat() && document.body.classList.contains('landscape-mode')) {
        return;
    }
    
    const isLandscape = window.matchMedia("(orientation: landscape)").matches;
    const gallery = document.getElementById('landscape-gallery-container');

    if (!gallery) return;

    if (isLandscape) {
        setupLandscapeImages();   // æ¨ªå±æ—¶é‡æ–°ç”Ÿæˆè°±å­
        gallery.style.display = 'flex';
        if (!isWeChat()) {  // å¾®ä¿¡ç¯å¢ƒä¸‹ä¸è‡ªåŠ¨æ·»åŠ class
            document.body.classList.add('landscape-mode');
        }
    } else {
        if (!isWeChat()) {  // å¾®ä¿¡ç¯å¢ƒä¸‹ä¸è‡ªåŠ¨ç§»é™¤class
            gallery.style.display = 'none';
            document.body.classList.remove('landscape-mode');
        }
    }
}

// é¡µé¢åŠ è½½ + æ–¹å‘å˜åŒ– éƒ½è¦è·‘ï¼ˆä½†å¾®ä¿¡ç¯å¢ƒä¸‹ä¼šè·³è¿‡è‡ªåŠ¨å¤„ç†ï¼‰
window.addEventListener('load', handleOrientationMode);
window.addEventListener('orientationchange', () => {
    setTimeout(handleOrientationMode, 300);
});
// åªåœ¨éå¾®ä¿¡ç¯å¢ƒä¸‹ç›‘å¬resizeäº‹ä»¶
if (!isWeChat()) {
    window.addEventListener('resize', handleOrientationMode);
}

function isLandscapeBySize() {
return window.innerWidth > window.innerHeight;
}

function enterLandscapeMode() {
    const wrapper = document.getElementById('wechatLandscapeWrapper');
    
    // åŠ¨æ€è®¾ç½®å®¹å™¨å°ºå¯¸ï¼ˆè§£å†³ç§»åŠ¨ç«¯ vh/vw ä¸å‡†ç¡®é—®é¢˜ï¼‰
    if (wrapper) {
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        
        // æ—‹è½¬åï¼šå®½åº¦=å±å¹•é«˜åº¦ï¼Œé«˜åº¦=å±å¹•å®½åº¦ï¼Œå·¦åç§»=å±å¹•å®½åº¦
        wrapper.style.width = screenHeight + 'px';
        wrapper.style.height = screenWidth + 'px';
        wrapper.style.left = screenWidth + 'px';
    }
    
    // è·å–ä¹è°±å›¾ç‰‡
    const originalContent = document.getElementById('original-content');
    const wlSheetArea = document.getElementById('wlSheetArea');

    if (originalContent && wlSheetArea) {
        const imgs = originalContent.querySelectorAll('img');
        if (imgs.length > 0) {
            // æœ‰å›¾ç‰‡ï¼šå¤åˆ¶ç¬¬ä¸€å¼ åˆ°æ—‹è½¬å®¹å™¨
            wlSheetArea.innerHTML = '';
            const img = document.createElement('img');
            img.src = imgs[0].src;
            img.alt = 'ä¹è°±';
            wlSheetArea.appendChild(img);
            
            // ç§»é™¤æ— ä¹è°±æ ‡è®°
            if (wrapper) wrapper.classList.remove('no-sheet');
        } else {
            // æ— å›¾ç‰‡ï¼šæ˜¾ç¤ºæç¤º
            wlSheetArea.innerHTML = '<div class="no-sheet">æš‚æ— ä¹è°±å›¾ç‰‡</div>';
            if (wrapper) wrapper.classList.add('no-sheet');
        }
    }

    // æ·»åŠ  landscape-mode ç±»
    document.body.classList.add('landscape-mode');

    // å¼ºåˆ¶è§¦å‘é‡æ’ç¡®ä¿æ ·å¼ç”Ÿæ•ˆ
    void document.body.offsetHeight;
}

function exitLandscapeMode() {
document.body.classList.remove('landscape-mode');

// å¦‚æœæ˜¯å¾®ä¿¡ç¯å¢ƒï¼Œæ¢å¤æŒ‰é’®æ˜¾ç¤º
if (isWeChat()) {
    const btn = document.getElementById('wechatLandscapeBtn');
    if (btn) {
        btn.style.display = 'block';
    }
}
}

function handleLandscapeLogic() {
const isLandscape = isLandscapeBySize();

if (isWeChat()) {
    // å¾®ä¿¡ï¼šä¸è‡ªåŠ¨è¿›å…¥æˆ–é€€å‡ºï¼Œä¿æŒå½“å‰çŠ¶æ€
    // å¦‚æœå·²ç»æ‰‹åŠ¨è¿›å…¥æ¨ªå±æ¨¡å¼ï¼Œå°±ä¸è¦è‡ªåŠ¨é€€å‡º
    return;
} else {
    // æµè§ˆå™¨ï¼šè‡ªåŠ¨
    if (isLandscape) {
        enterLandscapeMode();
    } else {
        exitLandscapeMode();
    }
}
}

// åªåœ¨éå¾®ä¿¡ç¯å¢ƒä¸‹è‡ªåŠ¨å¤„ç†æ¨ªå±
if (!isWeChat()) {
window.addEventListener('load', handleLandscapeLogic);
window.addEventListener('resize', handleLandscapeLogic);
}
document.addEventListener('DOMContentLoaded', () => {
// å¾®ä¿¡æ¨ªå±æŒ‰é’®
const btn = document.getElementById('wechatLandscapeBtn');
if (btn) {
    if (isWeChat()) {
        btn.style.display = 'block';
    }
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        enterLandscapeMode();
    });
}

// æ—‹è½¬å®¹å™¨å…³é—­æŒ‰é’®
const closeBtn = document.getElementById('wlCloseBtn');
if (closeBtn) {
    closeBtn.addEventListener('click', () => {
        exitLandscapeMode();
    });
}

// æ—‹è½¬å®¹å™¨é€Ÿåº¦æ§åˆ¶
const speedBtns = document.querySelectorAll('.wl-speed-btn');
const wlDemoAudio = document.getElementById('wlDemoAudio');
speedBtns.forEach(b => {
    b.addEventListener('click', () => {
        const speed = parseFloat(b.dataset.speed);
        if (wlDemoAudio) {
            wlDemoAudio.playbackRate = speed;
        }
        speedBtns.forEach(x => x.classList.remove('active'));
        b.classList.add('active');
    });
});

// æ—‹è½¬å®¹å™¨å½•éŸ³æŒ‰é’® - ä¸ä¸»å½•éŸ³æŒ‰é’®è”åŠ¨
const wlRecordBtn = document.getElementById('wlRecordBtn');
if (wlRecordBtn) {
    wlRecordBtn.addEventListener('click', () => {
        toggleRecording();
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateWlRecordBtn();
    });
}
});

// æ›´æ–°æ—‹è½¬å®¹å™¨å½•éŸ³æŒ‰é’®çŠ¶æ€
function updateWlRecordBtn() {
const wlRecordBtn = document.getElementById('wlRecordBtn');
if (!wlRecordBtn) return;

const icon = wlRecordBtn.querySelector('.icon');
const label = wlRecordBtn.querySelector('.label');

if (isRecording) {
    wlRecordBtn.classList.add('recording');
    if (icon) icon.textContent = 'â¹ï¸';
    if (label) label.textContent = 'åœæ­¢';
} else {
    wlRecordBtn.classList.remove('recording');
    if (icon) icon.textContent = 'ğŸ™ï¸';
    if (label) label.textContent = 'å¼€å§‹å½•éŸ³';
}
}

// é‡ç½®æ¨ªå±å½•éŸ³ç•Œé¢åˆ°åˆå§‹çŠ¶æ€
function resetWlToRecordState() {
    const wlRecordBtn = document.getElementById('wlRecordBtn');
    const wlReviewArea = document.getElementById('wlReviewArea');
    
    if (wlRecordBtn) wlRecordBtn.style.display = 'flex';
    if (wlReviewArea) wlReviewArea.style.display = 'none';
    
    // åŒæ—¶é‡ç½®ç«–å±ç•Œé¢
    resetToRecordState();
}

// æ¨ªå±æ¨¡å¼ä¸Šä¼ å½•éŸ³
function wlUploadBest() {
    if (!currentAudioBlob) return;
    
    const btn = document.getElementById('wlUploadBtn');
    if (!btn) return;
    
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "ä¸Šä¼ ä¸­...";

    const formData = new FormData();
    const timestamp = new Date().getTime();
    formData.append('audio_file', currentAudioBlob, `best_${timestamp}.${fileExtension}`);
    formData.append('exercise_id', '{{ exercise.id }}');

    fetch('/api/upload_practice/', { method: 'POST', body: formData })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerText = originalText;
        if (data.status === 'success') {
            let msg = data.msg;
            if (data.exp_earned) {
                msg += ` (+${data.exp_earned} XP)`;
            }
            showToast("âœ… " + msg, "success");
            setTimeout(() => {
                window.location.href = "{% url 'student_dashboard' %}";
            }, 1500);
        } else {
            showToast("ä¸Šä¼ å¤±è´¥: " + data.msg, "error");
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.disabled = false;
        btn.innerText = originalText;
        showToast("ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•", "error");
    });
}

// ç»‘å®šæ¨ªå±æŒ‰é’®äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    const wlRetryBtn = document.getElementById('wlRetryBtn');
    const wlUploadBtn = document.getElementById('wlUploadBtn');
    
    if (wlRetryBtn) {
        wlRetryBtn.addEventListener('click', resetWlToRecordState);
    }
    
    if (wlUploadBtn) {
        wlUploadBtn.addEventListener('click', wlUploadBest);
    }
});
</script>

{% endblock %}