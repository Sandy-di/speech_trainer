{% extends 'training/base.html' %}
{% load static %}
{% block content %}
<div class="container" style="max-width:900px;margin:0 auto;padding:40px 20px">
<h2 style="font-family:'Cinzel',serif;color:var(--primary-color);text-align:center;margin-bottom:30px">ğŸ“¢ {% if is_edit %}ç¼–è¾‘å…¬å‘Š{% else %}å‘å¸ƒæ–°å…¬å‘Š{% endif %}</h2>
<div style="background:#fff;padding:30px;border-radius:20px;box-shadow:var(--shadow-light)">
<form method="post" enctype="multipart/form-data" id="announcement-form">{% csrf_token %}{{ form.media }}
<div style="margin-bottom:20px"><label style="display:block;font-weight:bold;margin-bottom:10px;color:#555">å…¬å‘Šæ ‡é¢˜</label>{{ form.title }}</div>
<div style="margin-bottom:30px"><label style="display:block;font-weight:bold;margin-bottom:10px;color:#555">å…¬å‘Šå†…å®¹ (æ”¯æŒå›¾ç‰‡)</label>{{ form.content }}</div>
<div style="margin-bottom:30px;background:#f9f9f9;padding:15px;border-radius:10px;border:1px dashed #ddd">
<label style="display:block;font-weight:bold;margin-bottom:10px;color:#555">ğŸ™ï¸ è¯­éŸ³æ’­æŠ¥å½•åˆ¶ (å¯é€‰)</label>
{% if is_edit and announcement.audio_file %}<div style="margin-bottom:10px"><span style="color:#2ecc71">âœ… å·²æœ‰å½•éŸ³</span> <audio controls src="{{ announcement.audio_file.url }}" style="height:30px;vertical-align:middle"></audio></div>{% endif %}
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap"><button type="button" id="btn-start" style="padding:8px 15px;background:#e74c3c;color:#fff;border:none;border-radius:5px;cursor:pointer">å¼€å§‹å½•éŸ³</button><button type="button" id="btn-stop" disabled style="padding:8px 15px;background:#ddd;color:#666;border:none;border-radius:5px">åœæ­¢å½•éŸ³</button><span id="recording-status" style="color:#666;font-size:.9rem">æœªå¼€å§‹</span></div>
<audio id="audio-preview" controls style="display:none;width:100%;margin-top:15px"></audio>
<input type="file" name="audio_file" id="audio-file-input" style="display:none">
</div>
<div style="display:flex;gap:15px"><a href="{% url 'teacher_dashboard' %}" style="padding:15px;background:#eee;color:#666;border-radius:50px;text-decoration:none;text-align:center;flex:1">å–æ¶ˆ</a><button type="submit" style="flex:2;padding:15px;background:var(--primary-color);color:#fff;border:none;border-radius:50px;font-size:1rem;cursor:pointer">ğŸš€ {% if is_edit %}ä¿å­˜ä¿®æ”¹{% else %}ç«‹å³å‘å¸ƒ{% endif %}</button></div>
</form>
</div>
</div>
<script>
let mediaRecorder,audioChunks=[];const btnStart=document.getElementById('btn-start'),btnStop=document.getElementById('btn-stop'),status=document.getElementById('recording-status'),audioPreview=document.getElementById('audio-preview'),fileInput=document.getElementById('audio-file-input');
btnStart.addEventListener('click',async()=>{try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(stream);mediaRecorder.start();status.textContent="æ­£åœ¨å½•éŸ³... ğŸ™ï¸";status.style.color="#e74c3c";btnStart.disabled=true;btnStart.style.background="#ddd";btnStop.disabled=false;btnStop.style.background="#333";audioChunks=[];mediaRecorder.addEventListener("dataavailable",e=>audioChunks.push(e.data));mediaRecorder.addEventListener("stop",()=>{const blob=new Blob(audioChunks,{type:'audio/webm'});audioPreview.src=URL.createObjectURL(blob);audioPreview.style.display="block";const file=new File([blob],"voice.webm",{type:"audio/webm"});const dt=new DataTransfer();dt.items.add(file);fileInput.files=dt.files;status.textContent="å½•éŸ³å·²ä¿å­˜ âœ…";status.style.color="#2ecc71"})}catch(err){alert("æ— æ³•è®¿é—®éº¦å…‹é£: "+err)}});
btnStop.addEventListener('click',()=>{if(mediaRecorder&&mediaRecorder.state!=='inactive'){mediaRecorder.stop();btnStart.disabled=false;btnStart.style.background="#e74c3c";btnStop.disabled=true;btnStop.style.background="#ddd";mediaRecorder.stream.getTracks().forEach(t=>t.stop())}});
</script>
{% endblock %}